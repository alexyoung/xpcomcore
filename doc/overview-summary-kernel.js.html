<!doctype html public "-//W3C//DTD HTML 4.0 Frameset//EN""http://www.w3.org/TR/REC-html40/frameset.dtd">
<html>
<head>
<title>
XPCOMCore Overview
</title>
<link rel ="stylesheet" type="text/css" href="stylesheet.css" title="Style">
<script>
function asd() {
	
		parent.document.title="kernel.js Overview";
	
}
</script>
</head>
<body bgcolor="white" onload="asd();">

<!-- ========== START OF NAVBAR ========== -->
<a name="navbar_top"><!-- --></a>
<table border="0" width="100%" cellpadding="1" cellspacing="0">
<tr>
<td colspan=2 bgcolor="#EEEEFF" class="NavBarCell1">
<a name="navbar_top_firstrow"><!-- --></a>
<table border="0" cellpadding="0" cellspacing="3">
  <tr align="center" valign="top">
  
  
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-summary.html"><font class="NavBarFont1"><b>Overview</b></font></a>&nbsp;</td>
  <td bgcolor="#FFFFFF" class="NavBarCell1Rev">	&nbsp;<font class="NavBarFont1Rev"><b>File</b></font>&nbsp;</td>
  

  <td bgcolor="#FFFFFF" class="NavBarCell1"> 	<font class="NavBarFont1">Class</font>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-tree.html"><font class="NavBarFont1"><b>Tree</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="index-all.html"--><font class="NavBarFont1"><b>Index</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="help-doc.html"><font class="NavBarFont1"><b>Help</b></font></a>&nbsp;</td>
  </tr>
</table>
</td>
<td bgcolor="#EEEEFF" align="right" valign="top">
<em>
<b>XPCOMCore</b></em>
</td>
</tr>

<tr>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
&nbsp;PREV&nbsp;
&nbsp;NEXT</font></td>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
  <a href="index.html" target="_top"><b>FRAMES</b></a>  &nbsp;
&nbsp;<a href="overview-summary.html" target="_top"><b>NO FRAMES</b></a>
&nbsp;&nbsp;
<script>
  <!--
  if(window==top) {
    document.writeln('<A HREF="allclasses-noframe.html" TARGET=""><B>All Classes</B></A>');
  }
  //-->
</script>
<noscript>
<a href="allclasses-noframe.html" target=""><b>All Classes</b></a>
</noscript>
</font></td>
</tr>
</table>
<!-- =========== END OF NAVBAR =========== -->

<hr>
<center>
	
	   <h2>kernel.js</h2>
	
</center>

	


<h4>Summary</h4>
<p>
	
		This file specifies a set of globally useful features/shortcuts
 and defines our "Kernel" object, which is the base for doing a lot of simple
 things with XPCOMCore such as loading in other files and printing to the
 console.<BR/><BR/>
	
</p>

<hr>


    <table border="1" cellpadding="3" cellspacing="0" width="100%">
    <tr bgcolor="#CCCCFF" class="TableHeadingColor">
    <td colspan=2><font size="+2">
    
        <b>Class Summary</b>
    
    </font></td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="Kernel.html">Kernel</a></b></td>
    <td>Our central 'class' containing a lot of properties and methods we need to
 build the rest of XPCOMCore on top of.</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="LoadError.html">LoadError</a></b></td>
    <td>Exception representing an error loading a file.</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="SelfConceptError.html">SelfConceptError</a></b></td>
    <td>Exception representing an error determining what the path to the currently executing file is.</td>
    </tr>
    
    </table>
    <hr/> 


<!-- ========== METHOD SUMMARY =========== -->

<!-- ========== END METHOD SUMMARY =========== -->


        <pre class="sourceview"><span class="comment">/** 
 * <span class="attrib">@fileoverview</span> This file specifies a set of globally useful features/shortcuts
 * and defines our "Kernel" object, which is the base for doing a lot of simple
 * things with XPCOMCore such as loading in other files and printing to the
 * console.
 */</span>

<span class="comment">/** 
 * <span class="attrib">@class</span> Exception representing an error loading a file.
 * <span class="attrib">@extends</span> Error
 * <span class="attrib">@constructor</span>
 * <span class="attrib">@param</span> {String} message The error message to be given for this exception.
 * <span class="attrib">@type</span> Error
 */</span>
<span class="reserved">function</span> LoadError(message) {
  var err = new Error(message);
  err.name = arguments.callee.name;
  <span class="reserved">return</span> err;
};

<span class="comment">/** 
 * <span class="attrib">@class</span> Exception representing an error determining what the path to the currently executing file is.
 * <span class="attrib">@extends</span> Error
 * <span class="attrib">@constructor</span>
 * <span class="attrib">@param</span> {String} message The error message to be given for this exception.
 * <span class="attrib">@type</span> Error
 */</span>
<span class="reserved">function</span> SelfConceptError(message) {
  var err = new Error(message);
  err.name = arguments.callee.name;
  <span class="reserved">return</span> err;
};

<span class="comment">/**
 * A pseudo-constructor to make JSDoc happy and actually document things in {<span class="attrib">@link</span> Kernel}.
 * If this method is called with an argument, all properties from {<span class="attrib">@link</span> Kernel} are taken
 * and defined as the return value of getter methods set on the given object.
 * <span class="attrib">@class</span> Our central 'class' containing a lot of properties and methods we need to
 * build the rest of XPCOMCore on top of.
 * <span class="attrib">@param</span> {Object} mixinScope Optional argument, any object to mix {<span class="attrib">@link</span> Kernel}'s properties
 * into.
 * <span class="attrib">@return</span> The prototype object of the Kernel function.
 */</span>
<span class="reserved">function</span> Kernel(mixinScope) {
  var myPrototype = arguments.callee.<span class="reserved">prototype</span>;
  <span class="reserved">if</span> (mixinScope) {
    <span class="comment">// FIXME - figure out a better way than this object jammed in here to special case our</span>
    <span class="comment">// methods we really want to be calling getters when they're mixed in.</span>
    var callingGetters = {<span class="literal">'CURRENT_FILE'</span>: {defaultArgs: [2]}, <span class="literal">'CURRENT_DIRECTORY'</span>: {defaultArgs: [3] }};
    var makeGetter = <span class="reserved">function</span>(attr) { <span class="reserved">return</span> <span class="reserved">function</span>() { <span class="reserved">return</span> myPrototype[attr]; } };
    var makeCallingGetter = <span class="reserved">function</span>(attr, argsArray) { 
      <span class="reserved">return</span> <span class="reserved">function</span>() { 
        <span class="reserved">return</span> myPrototype[attr].apply(<span class="reserved">this</span>, argsArray); 
      }
    };
        
    <span class="reserved">for</span> (var p in myPrototype) { 
      <span class="reserved">if</span> (callingGetters[p]) {
        mixinScope.__defineGetter__(p, makeCallingGetter(p, callingGetters[p].defaultArgs || []));
      } <span class="reserved">else</span> {
        mixinScope.__defineGetter__(p, makeGetter(p)); 
      }
    };
    
    <span class="comment">// Load up our standard library into the mixinScope.</span>
    var standardLibraries = [<span class="literal">'file'</span>];
    var standardLibraryLoader = <span class="reserved">function</span>() {
      standardLibraries.forEach(<span class="reserved">function</span>(library) { require(library); }, <span class="reserved">this</span>);
    };
    standardLibraryLoader.call(mixinScope);
  };
  <span class="reserved">return</span> myPrototype;
};

Kernel.<span class="reserved">prototype</span> = {
  <span class="comment">/** 
   * A shortcut constant to Components.classes.
   * <span class="attrib">@final</span>
   */</span>
  Cc: Components.classes,

  <span class="comment">/** 
   * A shortcut constant to Components.interfaces.
   * <span class="attrib">@final</span>
   */</span>
  Ci: Components.interfaces,

  <span class="comment">/** 
   * A shortcut constant to Components.results.
   * <span class="attrib">@final</span>
   */</span>
  Cr: Components.results,

  <span class="comment">/** 
   * A shortcut constant to Components.utils.
   * <span class="attrib">@final</span>
   */</span>
  Cu: Components.utils,

  <span class="comment">/** 
   * Taking inspiration from Ruby, this defines the set of paths to check when
   * trying to load a file via either {<span class="attrib">@link</span> Kernel#load} or {<span class="attrib">@link</span> Kernel#require}.
   * <span class="attrib">@final</span>
   * <span class="attrib">@type</span> Array
   */</span>
  LOAD_PATH: [XPCOMCoreConfig.getProperty(<span class="literal">'libRoot'</span>)],

  <span class="comment">/** 
   * Taking inspiration from Ruby, this defines the currently loaded files that
   * have been loaded through {<span class="attrib">@link</span> Kernel#require}.
   * <span class="attrib">@final</span>
   * <span class="attrib">@type</span> Array
   */</span>
  LOADED_FEATURES: [<span class="literal">"kernel.js"</span>],
  
  <span class="comment">/** 
   * Taking inspiration from Ruby, this method tries to determine the filesystem path to
   * the caller code of this method.
   * NOTE - when {<span class="attrib">@link</span> Kernel} is mixed into an object, this function gets mixed in via
   * a special case behaviour that makes it a getter that actually calls the function 
   * rather than returning the function object itself. This is to facilitate being able
   * to call 'CURRENT_FILE' in your code rather than 'CURRENT_FILE()'. The stackTraversalDepth
   * parameter is there for this reason, since we need to traverse the stack further than
   * normal to find the calling scope than we normally would.
   * <span class="attrib">@type</span> String
   * <span class="attrib">@param</span> {int} stackTraversalDepth Optional argument, how far to look up the stack to
   * figure out who called us. The default is usually safe.
   * <span class="attrib">@throws</span> {<span class="attrib">@link</span> SelfConceptError} Thrown when we can't figure out what the filesystem
   * path to the current file is.
   */</span>
  CURRENT_FILE: <span class="reserved">function</span>(stackTraversalDepth) {
    try {
      var stackTraversalDepth = stackTraversalDepth || 1;
      var ioService = Cc[<span class="literal">"@mozilla.org/network/io-service;1"</span>].getService(Ci.nsIIOService);
      <span class="comment">// FIXME - UGH. This is so seedy.</span>
      <span class="comment">// Traverse up the stack as far as needed to get our caller's stack frame. Sometimes we need to</span>
      <span class="comment">// traverse more than one level up, like when this function is actually called from a getter</span>
      <span class="comment">// property that references it.</span>
      var callerStack = Components.stack;
      <span class="reserved">for</span> (var i = 0; i &lt; stackTraversalDepth; i++) {
        callerStack = callerStack.caller;
      }
      <span class="comment">// Split based on the stupid fucking " -&gt; " Gecko puts in the filename and get the last entry</span>
      var ostensiblyUs = callerStack.filename.split(<span class="literal">" -&gt; "</span>).slice(-1);
      var callerFileURI = ioService.newURI(ostensiblyUs, null, null);
      <span class="comment">// QI for an nsIFileURL which lets us get a handle on an actual file attribute and automagically does</span>
      <span class="comment">// resource: URL resolution for us</span>
      callerFileURI.QueryInterface(Ci.nsIFileURL);
      <span class="comment">// And theoretically, we can now get a handle on an nsIFile and return the path of that.</span>
      <span class="reserved">return</span> callerFileURI.file.path;
    } catch(e) {
      throw(new SelfConceptError(<span class="literal">"The filesystem location of the current file could not be determined. -- "</span> + e));
    }
  },
  
  <span class="comment">/** 
   * This method tries to determine the filesystem path to parent directory of the caller 
   * code of this method NOTE - see the note on CURRENT_FILE, as the same applies here.
   * <span class="attrib">@type</span> String
   * <span class="attrib">@param</span> {int} stackTraversalDepth Optional argument, how far to look up the stack to
   * figure out who called us. The default is usually safe.
   * <span class="attrib">@throws</span> {<span class="attrib">@link</span> SelfConceptError} Thrown when we can't figure out what the filesystem
   * path to the parent directory of the current file is.
   */</span>
  CURRENT_DIRECTORY: <span class="reserved">function</span>(stackTraversalDepth) {
    var stackTraversalDepth = stackTraversalDepth || 2;
    var currentFilePath = Kernel.<span class="reserved">prototype</span>.CURRENT_FILE(stackTraversalDepth);
    
    var fileObject = Cc[<span class="literal">"@mozilla.org/file/local;1"</span>].createInstance(Ci.nsILocalFile);
    fileObject.initWithPath(currentFilePath);

    <span class="reserved">return</span> fileObject.parent.path;
  },
  
  <span class="comment">/** 
   * Prints a string to standard out, without a trailing newline.
   * <span class="attrib">@param</span> {String} str String to print to standard out.
   */</span>
  print: <span class="reserved">function</span>(str) {
    dump(str);
  },
  
  <span class="comment">/** 
   * Prints a string to standard out, with a trailing newline.
   * <span class="attrib">@param</span> {String} str String to print to standard out.
   */</span>
  puts: <span class="reserved">function</span>(str) {
    print(str + <span class="literal">"\n"</span>);
  },
  
  <span class="comment">/**
   * Searches {<span class="attrib">@link</span> Kernel#LOAD_PATH LOAD_PATH} for files to load into the current global scope.
   * Files loaded via this method will not be added to {<span class="attrib">@link</span> Kernel#LOADED_FEATURES} and hence
   * can be repeatedly loaded and executed.
   * <span class="attrib">@param</span> {String} featurePath Full or relative path including file extension to try and load.
   * <span class="attrib">@type</span> Boolean
   * <span class="attrib">@throws</span> {<span class="attrib">@link</span> LoadError} Thrown when we can't find the specified file in any directories specified
   * in {<span class="attrib">@link</span> Kernel#LOAD_PATH LOAD_PATH}.
   */</span>
  load: <span class="reserved">function</span>(featurePath) {
    var loader = Cc[<span class="literal">"@mozilla.org/moz/jssubscript-loader;1"</span>].getService(Ci.mozIJSSubScriptLoader);
    var foundFile = null;
    <span class="comment">// FIXME - so this is kinda shitty. We have an empty entry here so we default to just trying to load </span>
    <span class="comment">// from an absolute path</span>
    var loadPath = LOAD_PATH.concat([<span class="literal">""</span>]);
    var loadPathLength = loadPath.length;
    <span class="comment">// FIXME - mozilla bug here. if i use foreach on array it ignores the granted security privileges</span>
    <span class="reserved">for</span> (var i = 0; i &lt; loadPathLength; i++) {
      var potentialFile = Cc[<span class="literal">"@mozilla.org/file/local;1"</span>].createInstance(Ci.nsILocalFile);
      potentialFile.initWithPath(loadPath[i] + <span class="literal">"/"</span> + featurePath);
      <span class="reserved">if</span> (potentialFile.exists()) { 
        foundFile = potentialFile; 
        break;
      }
    };
    <span class="reserved">if</span> (foundFile) {
      foundFile.normalize();
      loader.loadSubScript(<span class="literal">"file://"</span> + encodeURI(foundFile.path));
      <span class="reserved">return</span> true;
    } <span class="reserved">else</span> {
      throw(new LoadError(<span class="literal">"no such file to load -- "</span> + featurePath));
    }
  },

  <span class="comment">/**
   * Searches {<span class="attrib">@link</span> Kernel#LOAD_PATH LOAD_PATH} for features to load into the current global scope.
   * Files loaded via this method will be added to {<span class="attrib">@link</span> Kernel#LOADED_FEATURES} and hence two 
   * consecutive calls to this method will not load and execute the code twice.
   * <span class="attrib">@type</span> Boolean True if successful, false if the specified feature has already been required.
   * <span class="attrib">@param</span> {String} featurePath Full or relative path without the file extension to try and require.
   * <span class="attrib">@throws</span> {<span class="attrib">@link</span> LoadError} Thrown when we can't find the specified feature in any directories specified
   * in {<span class="attrib">@link</span> Kernel#LOAD_PATH LOAD_PATH}.
   */</span>  
  require: <span class="reserved">function</span>(feature) {
    var jsFeature = feature + <span class="literal">".js"</span>;
    <span class="reserved">if</span> (LOADED_FEATURES.indexOf(jsFeature) == -1) {
      load(jsFeature);
      LOADED_FEATURES.push(jsFeature);
      <span class="reserved">return</span> true;
    } <span class="reserved">else</span> {
      <span class="reserved">return</span> false;
    }
  }
};</pre>
	<hr>



<!-- ========== START OF NAVBAR ========== -->
<a name="navbar_top"><!-- --></a>
<table border="0" width="100%" cellpadding="1" cellspacing="0">
<tr>
<td colspan=2 bgcolor="#EEEEFF" class="NavBarCell1">
<a name="navbar_top_firstrow"><!-- --></a>
<table border="0" cellpadding="0" cellspacing="3">
  <tr align="center" valign="top">
  
  
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-summary.html"><font class="NavBarFont1"><b>Overview</b></font></a>&nbsp;</td>
  <td bgcolor="#FFFFFF" class="NavBarCell1Rev">	&nbsp;<font class="NavBarFont1Rev"><b>File</b></font>&nbsp;</td>
  

  <td bgcolor="#FFFFFF" class="NavBarCell1"> <font class="NavBarFont1">Class</font>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-tree.html"><font class="NavBarFont1"><b>Tree</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="index-all.html"--><font class="NavBarFont1"><b>Index</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="help-doc.html"><font class="NavBarFont1"><b>Help</b></font></a>&nbsp;</td>
  </tr>
</table>
</td>
<td bgcolor="#EEEEFF" align="right" valign="top"><em>
<b>XPCOMCore</b></em>
</td>
</tr>

<tr>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
&nbsp;PREV&nbsp;
&nbsp;NEXT</font></td>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
  <a href="index.html" target="_top"><b>FRAMES</b></a>  &nbsp;
&nbsp;<a href="overview-summary.html" target="_top"><b>NO FRAMES</b></a>
&nbsp;&nbsp;
<script>
  <!--
  if(window==top) {
    document.writeln('<A HREF="allclasses-noframe.html" TARGET=""><B>All Classes</B></A>');
  }
  //-->
</script>
<noscript>
<a href="allclasses-noframe.html" target=""><b>All Classes</b></a>
</noscript>
</font></td>
</tr>
</table>
<!-- =========== END OF NAVBAR =========== -->

<hr>
<font size="-1">

</font>
<div class="jsdoc_ctime">Documentation generated by <a href="http://jsdoc.sourceforge.net/" target="_parent">JSDoc</a> on Tue Sep 15 18:21:18 2009</div>
</body>
</html>
